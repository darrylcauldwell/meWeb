---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import PostCard from '../../components/PostCard.astro';
import { CATEGORIES } from '../../content.config';
import { categoryLabels, getCategoryColor } from '../../config/colors';

export async function getStaticPaths() {
  const allPosts = await getCollection('post', ({ data }) => !data.draft);

  return CATEGORIES.map((category) => {
    const filteredPosts = allPosts
      .filter((post) => post.data.category === category)
      .sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());

    return {
      params: { category },
      props: {
        category,
        posts: filteredPosts,
      },
    };
  });
}

interface Props {
  category: string;
  posts: any[];
}

const { category, posts } = Astro.props;

const categoryDescriptions: Record<string, string> = {
  cloud: 'AWS, Azure, and cloud-native technologies',
  kubernetes: 'Kubernetes, Tanzu, containers, and cloud-native platforms',
  vmware: 'vSphere, NSX, VCF, and VMware ecosystem',
  automation: 'Infrastructure as code, CI/CD, and scripting',
  homelab: 'Home lab projects, Raspberry Pi, and personal experiments',
  career: 'DevOps culture, certifications, and professional growth',
  apps: 'Mobile app development, iOS, watchOS, and sensor-driven applications',
};

const categoryTitle = categoryLabels[category] || category;
const categoryColor = getCategoryColor(category);
---

<BaseLayout title={categoryTitle} description={categoryDescriptions[category]}>
  <div class="max-w-[var(--max-width)] mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <main class="max-w-3xl mx-auto">
      <!-- Category header with color accent -->
      <header class="mb-8 pb-6 border-b-2" style={`border-color: ${categoryColor};`}>
        <div class="flex items-center gap-3 mb-2">
          <span
            class="px-3 py-1 text-[var(--color-dark)] rounded-full text-sm font-semibold"
            style={`background-color: ${categoryColor};`}
          >
            {categoryTitle}
          </span>
          <span class="text-[var(--color-text-muted)] text-sm">{posts.length} posts</span>
        </div>
        <p class="text-[var(--color-text)]">{categoryDescriptions[category]}</p>
      </header>

      {posts.length > 0 ? (
        <div class="space-y-6">
          {posts.map((post) => (
            <PostCard
              title={post.data.title}
              description={post.data.description}
              date={post.data.date}
              category={post.data.category}
              slug={post.id}
            />
          ))}
        </div>
      ) : (
        <p class="text-[var(--color-text)]">No posts found in this category.</p>
      )}
    </main>
  </div>
</BaseLayout>
