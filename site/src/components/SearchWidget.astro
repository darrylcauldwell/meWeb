---
// Search widget using Pagefind
---

<button
  id="search-btn"
  class="p-2 rounded-full hover:bg-[var(--color-header-hover-bg)] transition-colors"
  aria-label="Search"
>
  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path
      stroke-linecap="round"
      stroke-linejoin="round"
      stroke-width="2"
      d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
    />
  </svg>
</button>

<!-- Search Modal -->
<div
  id="search-modal"
  class="fixed inset-0 z-[100] hidden"
  role="dialog"
  aria-modal="true"
  aria-labelledby="search-modal-title"
>
  <!-- Backdrop -->
  <div class="fixed inset-0 bg-black/50 backdrop-blur-sm" id="search-backdrop"></div>

  <!-- Modal content -->
  <div class="fixed inset-x-4 top-20 md:inset-x-auto md:left-1/2 md:-translate-x-1/2 md:w-full md:max-w-2xl">
    <div class="bg-[var(--color-bg)] rounded-lg shadow-2xl overflow-hidden">
      <!-- Search input -->
      <div class="p-4 border-b border-[var(--color-translucent)]">
        <h2 id="search-modal-title" class="sr-only">Search posts</h2>
        <div class="flex items-center gap-3">
          <svg class="w-5 h-5 text-[var(--color-text)]" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <input
            id="search-input"
            type="text"
            placeholder="Search posts..."
            class="flex-1 bg-transparent border-none outline-none text-[var(--color-text)] placeholder-[var(--color-text)]/50"
            autocomplete="off"
          />
          <kbd class="hidden sm:inline-block px-2 py-1 text-xs text-[var(--color-text)]/50 bg-[var(--color-translucent)] rounded">ESC</kbd>
        </div>
      </div>

      <!-- Search results -->
      <div id="search-results" class="max-h-96 overflow-y-auto p-4">
        <p class="text-sm text-[var(--color-text)]/50">Start typing to search...</p>
      </div>
    </div>
  </div>
</div>

<script>
  const searchBtn = document.getElementById('search-btn');
  const searchModal = document.getElementById('search-modal');
  const searchBackdrop = document.getElementById('search-backdrop');
  const searchInput = document.getElementById('search-input') as HTMLInputElement;
  const searchResults = document.getElementById('search-results');

  let pagefind: any = null;

  async function loadPagefind() {
    if (pagefind) return pagefind;
    try {
      // @ts-ignore - pagefind is loaded at runtime
      pagefind = await import('/pagefind/pagefind.js');
      await pagefind.init();
      return pagefind;
    } catch {
      // Pagefind not available - will show fallback message to user
      return null;
    }
  }

  function openSearch() {
    searchModal?.classList.remove('hidden');
    searchInput?.focus();
    document.body.style.overflow = 'hidden';
    loadPagefind();
  }

  function closeSearch() {
    searchModal?.classList.add('hidden');
    document.body.style.overflow = '';
    if (searchInput) searchInput.value = '';
    if (searchResults) searchResults.innerHTML = '<p class="text-sm text-[var(--color-text)]/50">Start typing to search...</p>';
    // Return focus to search button for keyboard users
    searchBtn?.focus();
  }

  searchBtn?.addEventListener('click', openSearch);
  searchBackdrop?.addEventListener('click', closeSearch);

  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    if (e.key === 'k' && (e.metaKey || e.ctrlKey)) {
      e.preventDefault();
      if (searchModal?.classList.contains('hidden')) {
        openSearch();
      } else {
        closeSearch();
      }
    }
    if (e.key === 'Escape' && !searchModal?.classList.contains('hidden')) {
      closeSearch();
    }
  });

  // Search functionality
  let debounceTimer: ReturnType<typeof setTimeout>;

  searchInput?.addEventListener('input', (e) => {
    clearTimeout(debounceTimer);
    const query = (e.target as HTMLInputElement).value;

    if (!query) {
      if (searchResults) {
        searchResults.innerHTML = '<p class="text-sm text-[var(--color-text)]/50">Start typing to search...</p>';
      }
      return;
    }

    // Show loading indicator
    if (searchResults) {
      searchResults.innerHTML = '<p class="text-sm text-[var(--color-text)]/50 flex items-center gap-2"><svg class="animate-spin h-4 w-4" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Searching...</p>';
    }

    debounceTimer = setTimeout(async () => {
      const pf = await loadPagefind();
      if (!pf) {
        if (searchResults) {
          searchResults.innerHTML = '<p class="text-sm text-[var(--color-text)]/50">Search is not available yet. Run npm run build first.</p>';
        }
        return;
      }

      const search = await pf.search(query);

      if (!searchResults) return;

      if (search.results.length === 0) {
        searchResults.innerHTML = '<p class="text-sm text-[var(--color-text)]/50">No results found.</p>';
        return;
      }

      const results = await Promise.all(
        search.results.slice(0, 10).map((r: any) => r.data())
      );

      searchResults.innerHTML = results
        .map(
          (r: any) => `
          <a href="${r.url}" class="block p-3 -mx-3 rounded-lg hover:bg-[var(--color-translucent)] transition-colors">
            <h3 class="font-medium text-[var(--color-heading)]">${r.meta?.title || 'Untitled'}</h3>
            <p class="text-sm text-[var(--color-text)]/70 mt-1 line-clamp-2">${r.excerpt}</p>
          </a>
        `
        )
        .join('');
    }, 200);
  });
</script>
