---
import ThemeToggle from './ThemeToggle.astro';
import SearchWidget from './SearchWidget.astro';
import { navCategories as categories, meLinks, presentationLinks, appsLinks } from '../config/colors';

---

<header class="bg-[var(--color-bg-header)] text-[var(--color-header-text-active)] sticky top-0 z-50">
  <nav class="max-w-[var(--max-width)] mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex items-center justify-between h-16">
      <!-- Logo -->
      <a href="/" class="text-xl font-bold hover:text-[var(--color-accent)] transition-colors">
        Darryl Cauldwell
      </a>

      <!-- Desktop Navigation -->
      <div class="hidden lg:flex items-center gap-2">
        <!-- Blog Dropdown -->
        <div class="relative" id="blog-dropdown">
          <button
            id="blog-dropdown-btn"
            class="flex items-center gap-1 px-3 py-2 text-sm font-medium rounded-md transition-colors text-[var(--color-header-text)] hover:text-[var(--color-header-text-active)] hover:bg-[var(--color-header-hover-bg)]"
            aria-haspopup="true"
            aria-expanded="false"
            aria-controls="blog-dropdown-menu"
          >
            <span>Blog</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>

          <!-- Dropdown Menu -->
          <div
            id="blog-dropdown-menu"
            class="absolute left-0 top-full mt-1 w-52 bg-[var(--color-bg-elevated)] rounded-lg shadow-lg border border-[var(--color-translucent)] hidden z-50"
            role="menu"
            aria-labelledby="blog-dropdown-btn"
          >
            {categories.map((item) => (
              <a
                href={item.href}
                class="block px-4 py-2 text-sm transition-colors first:rounded-t-lg last:rounded-b-lg text-[var(--color-text)] hover:bg-[var(--color-translucent)]"
                role="menuitem"
              >
                {item.label}
              </a>
            ))}
          </div>
        </div>

        <!-- Me Dropdown -->
        <div class="relative" id="me-dropdown">
          <button
            id="me-dropdown-btn"
            class="flex items-center gap-1 px-3 py-2 text-sm font-medium rounded-md transition-colors text-[var(--color-header-text)] hover:text-[var(--color-header-text-active)] hover:bg-[var(--color-header-hover-bg)]"
            aria-haspopup="true"
            aria-expanded="false"
            aria-controls="me-dropdown-menu"
          >
            <span>Me</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>

          <!-- Dropdown Menu -->
          <div
            id="me-dropdown-menu"
            class="absolute left-0 top-full mt-1 w-52 bg-[var(--color-bg-elevated)] rounded-lg shadow-lg border border-[var(--color-translucent)] hidden z-50"
            role="menu"
            aria-labelledby="me-dropdown-btn"
          >
            {meLinks.map((item) => (
              <a
                href={item.href}
                class="block px-4 py-2 text-sm transition-colors first:rounded-t-lg last:rounded-b-lg text-[var(--color-text)] hover:bg-[var(--color-translucent)]"
                role="menuitem"
              >
                {item.label}
              </a>
            ))}
          </div>
        </div>

        <!-- Presentations Dropdown -->
        <div class="relative" id="presentations-dropdown">
          <button
            id="presentations-dropdown-btn"
            class="flex items-center gap-1 px-3 py-2 text-sm font-medium rounded-md transition-colors text-[var(--color-header-text)] hover:text-[var(--color-header-text-active)] hover:bg-[var(--color-header-hover-bg)]"
            aria-haspopup="true"
            aria-expanded="false"
            aria-controls="presentations-dropdown-menu"
          >
            <span>Presentations</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>

          <!-- Dropdown Menu -->
          <div
            id="presentations-dropdown-menu"
            class="absolute left-0 top-full mt-1 w-52 bg-[var(--color-bg-elevated)] rounded-lg shadow-lg border border-[var(--color-translucent)] hidden z-50"
            role="menu"
            aria-labelledby="presentations-dropdown-btn"
          >
            {presentationLinks.map((item) => (
              <a
                href={item.href}
                class="block px-4 py-2 text-sm transition-colors first:rounded-t-lg last:rounded-b-lg text-[var(--color-text)] hover:bg-[var(--color-translucent)]"
                role="menuitem"
              >
                {item.label}
              </a>
            ))}
          </div>
        </div>

        <!-- Apps Dropdown -->
        <div class="relative" id="apps-dropdown">
          <button
            id="apps-dropdown-btn"
            class="flex items-center gap-1 px-3 py-2 text-sm font-medium rounded-md transition-colors text-[var(--color-header-text)] hover:text-[var(--color-header-text-active)] hover:bg-[var(--color-header-hover-bg)]"
            aria-haspopup="true"
            aria-expanded="false"
            aria-controls="apps-dropdown-menu"
          >
            <span>Apps</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>

          <!-- Dropdown Menu -->
          <div
            id="apps-dropdown-menu"
            class="absolute left-0 top-full mt-1 w-52 bg-[var(--color-bg-elevated)] rounded-lg shadow-lg border border-[var(--color-translucent)] hidden z-50"
            role="menu"
            aria-labelledby="apps-dropdown-btn"
          >
            {appsLinks.map((item) => (
              <a
                href={item.href}
                {...(item.external ? { target: '_blank', rel: 'noopener noreferrer' } : {})}
                class={`block px-4 py-2 text-sm transition-colors first:rounded-t-lg last:rounded-b-lg text-[var(--color-text)] hover:bg-[var(--color-translucent)] ${item.external ? 'flex items-center justify-between' : ''}`}
                role="menuitem"
              >
                <span>{item.label}</span>
                {item.external && (
                  <svg class="w-3 h-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                  </svg>
                )}
              </a>
            ))}
          </div>
        </div>

        <!-- Observability Link -->
        <a
          href="/observability/"
          class="px-3 py-2 text-sm font-medium rounded-md transition-colors no-underline !text-[var(--color-header-text)] hover:!text-[var(--color-header-text-active)] hover:bg-[var(--color-header-hover-bg)]"
        >
          Observability
        </a>

        <div class="flex items-center gap-2 ml-2 pl-4 border-l border-[var(--color-header-border)]">
          <SearchWidget />
          <ThemeToggle />
        </div>
      </div>

      <!-- Mobile menu button -->
      <div class="flex items-center gap-2 lg:hidden">
        <SearchWidget />
        <ThemeToggle />
        <button
          id="mobile-menu-btn"
          class="p-2 text-[var(--color-header-text)] hover:text-[var(--color-header-text-active)]"
          aria-label="Toggle menu"
          aria-expanded="false"
          aria-controls="mobile-menu"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
      </div>
    </div>

    <!-- Mobile Navigation -->
    <div id="mobile-menu" class="hidden lg:hidden pb-4">
      <div class="flex flex-col">
        <!-- Blog Accordion -->
        <div class="mobile-accordion">
          <button
            type="button"
            class="mobile-accordion-btn flex items-center justify-between w-full px-3 py-3 text-sm font-semibold text-[var(--color-text)] hover:bg-[var(--color-translucent)] rounded-md"
            aria-expanded="false"
            style="touch-action: manipulation"
          >
            <span>Blog</span>
            <svg class="w-4 h-4 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>
          <div class="mobile-accordion-content hidden pl-4">
            {categories.map((item) => (
              <a
                href={item.href}
                class="block px-3 py-3 rounded-md text-sm transition-colors text-[var(--color-text-muted)] hover:text-[var(--color-text)] hover:bg-[var(--color-translucent)]"
              >
                {item.label}
              </a>
            ))}
          </div>
        </div>

        <!-- Me Accordion -->
        <div class="mobile-accordion">
          <button
            type="button"
            class="mobile-accordion-btn flex items-center justify-between w-full px-3 py-3 text-sm font-semibold text-[var(--color-text)] hover:bg-[var(--color-translucent)] rounded-md"
            aria-expanded="false"
            style="touch-action: manipulation"
          >
            <span>Me</span>
            <svg class="w-4 h-4 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>
          <div class="mobile-accordion-content hidden pl-4">
            {meLinks.map((item) => (
              <a
                href={item.href}
                class="block px-3 py-3 rounded-md text-sm transition-colors text-[var(--color-text-muted)] hover:text-[var(--color-text)] hover:bg-[var(--color-translucent)]"
              >
                {item.label}
              </a>
            ))}
          </div>
        </div>

        <!-- Presentations Accordion -->
        <div class="mobile-accordion">
          <button
            type="button"
            class="mobile-accordion-btn flex items-center justify-between w-full px-3 py-3 text-sm font-semibold text-[var(--color-text)] hover:bg-[var(--color-translucent)] rounded-md"
            aria-expanded="false"
            style="touch-action: manipulation"
          >
            <span>Presentations</span>
            <svg class="w-4 h-4 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>
          <div class="mobile-accordion-content hidden pl-4">
            {presentationLinks.map((item) => (
              <a
                href={item.href}
                class="block px-3 py-3 rounded-md text-sm transition-colors text-[var(--color-text-muted)] hover:text-[var(--color-text)] hover:bg-[var(--color-translucent)]"
              >
                {item.label}
              </a>
            ))}
          </div>
        </div>

        <!-- Apps Accordion -->
        <div class="mobile-accordion">
          <button
            type="button"
            class="mobile-accordion-btn flex items-center justify-between w-full px-3 py-3 text-sm font-semibold text-[var(--color-text)] hover:bg-[var(--color-translucent)] rounded-md"
            aria-expanded="false"
            style="touch-action: manipulation"
          >
            <span>Apps</span>
            <svg class="w-4 h-4 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>
          <div class="mobile-accordion-content hidden pl-4">
            {appsLinks.map((item) => (
              <a
                href={item.href}
                {...(item.external ? { target: '_blank', rel: 'noopener noreferrer' } : {})}
                class={`block px-3 py-3 rounded-md text-sm transition-colors text-[var(--color-text-muted)] hover:text-[var(--color-text)] hover:bg-[var(--color-translucent)] ${item.external ? 'flex items-center justify-between' : ''}`}
              >
                <span>{item.label}</span>
                {item.external && (
                  <svg class="w-3 h-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                  </svg>
                )}
              </a>
            ))}
          </div>
        </div>

        <!-- Observability (standalone link) -->
        <a
          href="/observability/"
          class="px-3 py-3 rounded-md text-sm font-semibold transition-colors text-[var(--color-text)] hover:bg-[var(--color-translucent)]"
        >
          Observability
        </a>
      </div>
    </div>
  </nav>
</header>

<script>
  // Mobile menu toggle with focus management
  const menuBtn = document.getElementById('mobile-menu-btn');
  const mobileMenu = document.getElementById('mobile-menu');

  menuBtn?.addEventListener('click', () => {
    const isHidden = mobileMenu?.classList.toggle('hidden');
    menuBtn?.setAttribute('aria-expanded', String(!isHidden));
    // Move focus to first link when menu opens
    if (!isHidden) {
      const firstLink = mobileMenu?.querySelector('a') as HTMLElement;
      firstLink?.focus();
    }
  });

  // Auto-close mobile menu when clicking a link
  mobileMenu?.querySelectorAll('a').forEach(link => {
    link.addEventListener('click', () => {
      mobileMenu?.classList.add('hidden');
    });
  });

  // Mobile accordion toggle
  const accordionBtns = document.querySelectorAll('.mobile-accordion-btn');
  accordionBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const content = btn.nextElementSibling as HTMLElement;
      const chevron = btn.querySelector('svg');
      const isExpanded = btn.getAttribute('aria-expanded') === 'true';

      // Toggle current accordion
      btn.setAttribute('aria-expanded', String(!isExpanded));
      content?.classList.toggle('hidden');
      chevron?.classList.toggle('rotate-180');

      // Optionally close other accordions (single-open mode)
      accordionBtns.forEach(otherBtn => {
        if (otherBtn !== btn) {
          const otherContent = otherBtn.nextElementSibling as HTMLElement;
          const otherChevron = otherBtn.querySelector('svg');
          otherBtn.setAttribute('aria-expanded', 'false');
          otherContent?.classList.add('hidden');
          otherChevron?.classList.remove('rotate-180');
        }
      });
    });
  });

  // Dropdown elements
  const blogDropdownBtn = document.getElementById('blog-dropdown-btn');
  const blogDropdownMenu = document.getElementById('blog-dropdown-menu');
  const blogDropdown = document.getElementById('blog-dropdown');
  const meDropdownBtn = document.getElementById('me-dropdown-btn');
  const meDropdownMenu = document.getElementById('me-dropdown-menu');
  const meDropdown = document.getElementById('me-dropdown');
  const presentationsDropdownBtn = document.getElementById('presentations-dropdown-btn');
  const presentationsDropdownMenu = document.getElementById('presentations-dropdown-menu');
  const presentationsDropdown = document.getElementById('presentations-dropdown');
  const appsDropdownBtn = document.getElementById('apps-dropdown-btn');
  const appsDropdownMenu = document.getElementById('apps-dropdown-menu');
  const appsDropdown = document.getElementById('apps-dropdown');

  function updateAriaExpanded() {
    const blogOpen = !blogDropdownMenu?.classList.contains('hidden');
    const meOpen = !meDropdownMenu?.classList.contains('hidden');
    const presentationsOpen = !presentationsDropdownMenu?.classList.contains('hidden');
    const appsOpen = !appsDropdownMenu?.classList.contains('hidden');
    blogDropdownBtn?.setAttribute('aria-expanded', String(blogOpen));
    meDropdownBtn?.setAttribute('aria-expanded', String(meOpen));
    presentationsDropdownBtn?.setAttribute('aria-expanded', String(presentationsOpen));
    appsDropdownBtn?.setAttribute('aria-expanded', String(appsOpen));
  }

  // Get menu items for a dropdown
  function getMenuItems(menu: HTMLElement | null): HTMLElement[] {
    return menu ? Array.from(menu.querySelectorAll('[role="menuitem"]')) : [];
  }

  // Focus management for dropdown menus
  function focusMenuItem(menu: HTMLElement | null, index: number) {
    const items = getMenuItems(menu);
    if (items.length > 0) {
      const targetIndex = ((index % items.length) + items.length) % items.length;
      items[targetIndex].focus();
    }
  }

  function getCurrentFocusIndex(menu: HTMLElement | null): number {
    const items = getMenuItems(menu);
    return items.findIndex(item => item === document.activeElement);
  }

  // Open dropdown and focus first item
  function openDropdown(menu: HTMLElement | null, btn: HTMLElement | null) {
    menu?.classList.remove('hidden');
    updateAriaExpanded();
    // Focus first menu item
    setTimeout(() => focusMenuItem(menu, 0), 10);
  }

  // Close dropdown and return focus to button
  function closeDropdown(menu: HTMLElement | null, btn: HTMLElement | null) {
    menu?.classList.add('hidden');
    updateAriaExpanded();
    btn?.focus();
  }

  // Blog dropdown click handler
  blogDropdownBtn?.addEventListener('click', (e) => {
    e.stopPropagation();
    const isOpen = !blogDropdownMenu?.classList.contains('hidden');
    meDropdownMenu?.classList.add('hidden');
    presentationsDropdownMenu?.classList.add('hidden');
    appsDropdownMenu?.classList.add('hidden');
    if (isOpen) {
      closeDropdown(blogDropdownMenu, blogDropdownBtn);
    } else {
      openDropdown(blogDropdownMenu, blogDropdownBtn);
    }
  });

  // Me dropdown click handler
  meDropdownBtn?.addEventListener('click', (e) => {
    e.stopPropagation();
    const isOpen = !meDropdownMenu?.classList.contains('hidden');
    blogDropdownMenu?.classList.add('hidden');
    presentationsDropdownMenu?.classList.add('hidden');
    appsDropdownMenu?.classList.add('hidden');
    if (isOpen) {
      closeDropdown(meDropdownMenu, meDropdownBtn);
    } else {
      openDropdown(meDropdownMenu, meDropdownBtn);
    }
  });

  // Presentations dropdown click handler
  presentationsDropdownBtn?.addEventListener('click', (e) => {
    e.stopPropagation();
    const isOpen = !presentationsDropdownMenu?.classList.contains('hidden');
    blogDropdownMenu?.classList.add('hidden');
    meDropdownMenu?.classList.add('hidden');
    appsDropdownMenu?.classList.add('hidden');
    if (isOpen) {
      closeDropdown(presentationsDropdownMenu, presentationsDropdownBtn);
    } else {
      openDropdown(presentationsDropdownMenu, presentationsDropdownBtn);
    }
  });

  // Apps dropdown click handler
  appsDropdownBtn?.addEventListener('click', (e) => {
    e.stopPropagation();
    const isOpen = !appsDropdownMenu?.classList.contains('hidden');
    blogDropdownMenu?.classList.add('hidden');
    meDropdownMenu?.classList.add('hidden');
    presentationsDropdownMenu?.classList.add('hidden');
    if (isOpen) {
      closeDropdown(appsDropdownMenu, appsDropdownBtn);
    } else {
      openDropdown(appsDropdownMenu, appsDropdownBtn);
    }
  });

  // Keyboard navigation for dropdowns
  function handleDropdownKeydown(e: KeyboardEvent, menu: HTMLElement | null, btn: HTMLElement | null) {
    const items = getMenuItems(menu);
    const currentIndex = getCurrentFocusIndex(menu);
    const isOpen = !menu?.classList.contains('hidden');

    switch (e.key) {
      case 'ArrowDown':
        e.preventDefault();
        if (!isOpen) {
          openDropdown(menu, btn);
        } else {
          focusMenuItem(menu, currentIndex + 1);
        }
        break;
      case 'ArrowUp':
        e.preventDefault();
        if (isOpen) {
          focusMenuItem(menu, currentIndex - 1);
        }
        break;
      case 'Home':
        e.preventDefault();
        if (isOpen) focusMenuItem(menu, 0);
        break;
      case 'End':
        e.preventDefault();
        if (isOpen) focusMenuItem(menu, items.length - 1);
        break;
      case 'Escape':
        if (isOpen) {
          e.preventDefault();
          closeDropdown(menu, btn);
        }
        break;
      case 'Tab':
        if (isOpen) {
          menu?.classList.add('hidden');
          updateAriaExpanded();
        }
        break;
    }
  }

  // Add keyboard listeners to dropdown buttons
  blogDropdownBtn?.addEventListener('keydown', (e) => {
    handleDropdownKeydown(e, blogDropdownMenu, blogDropdownBtn);
  });

  meDropdownBtn?.addEventListener('keydown', (e) => {
    handleDropdownKeydown(e, meDropdownMenu, meDropdownBtn);
  });

  presentationsDropdownBtn?.addEventListener('keydown', (e) => {
    handleDropdownKeydown(e, presentationsDropdownMenu, presentationsDropdownBtn);
  });

  appsDropdownBtn?.addEventListener('keydown', (e) => {
    handleDropdownKeydown(e, appsDropdownMenu, appsDropdownBtn);
  });

  // Add keyboard listeners to menu items
  blogDropdownMenu?.addEventListener('keydown', (e) => {
    handleDropdownKeydown(e, blogDropdownMenu, blogDropdownBtn);
  });

  meDropdownMenu?.addEventListener('keydown', (e) => {
    handleDropdownKeydown(e, meDropdownMenu, meDropdownBtn);
  });

  presentationsDropdownMenu?.addEventListener('keydown', (e) => {
    handleDropdownKeydown(e, presentationsDropdownMenu, presentationsDropdownBtn);
  });

  appsDropdownMenu?.addEventListener('keydown', (e) => {
    handleDropdownKeydown(e, appsDropdownMenu, appsDropdownBtn);
  });

  // Close dropdowns when clicking outside
  document.addEventListener('click', (e) => {
    if (!blogDropdown?.contains(e.target as Node)) {
      blogDropdownMenu?.classList.add('hidden');
    }
    if (!meDropdown?.contains(e.target as Node)) {
      meDropdownMenu?.classList.add('hidden');
    }
    if (!presentationsDropdown?.contains(e.target as Node)) {
      presentationsDropdownMenu?.classList.add('hidden');
    }
    if (!appsDropdown?.contains(e.target as Node)) {
      appsDropdownMenu?.classList.add('hidden');
    }
    updateAriaExpanded();
  });

  // Global escape key handler
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      const blogOpen = !blogDropdownMenu?.classList.contains('hidden');
      const meOpen = !meDropdownMenu?.classList.contains('hidden');
      const presentationsOpen = !presentationsDropdownMenu?.classList.contains('hidden');
      const appsOpen = !appsDropdownMenu?.classList.contains('hidden');
      if (blogOpen) closeDropdown(blogDropdownMenu, blogDropdownBtn);
      if (meOpen) closeDropdown(meDropdownMenu, meDropdownBtn);
      if (presentationsOpen) closeDropdown(presentationsDropdownMenu, presentationsDropdownBtn);
      if (appsOpen) closeDropdown(appsDropdownMenu, appsDropdownBtn);
    }
  });
</script>
